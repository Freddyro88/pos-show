<div class="container">
  <header class="header">
    <div>
      <h1>Admin – Produkte</h1>
      <p class="muted">Produkte hinzufügen, Preise ändern, löschen (offline).</p>
    </div>

    <div class="total">
      <div class="muted">Status</div>
      <div class="totalValue">{{ isAdmin ? 'ADMIN' : 'GESPERRT' }}</div>
    </div>
  </header>

  @if (!isAdmin) {
    <section class="checkout">
      <div class="checkoutBox">
        <div>
          <div class="muted">PIN eingeben</div>
          <input
            type="password"
            [(ngModel)]="pinInput"
            placeholder="PIN"
            style="padding: 12px; border-radius: 12px; width: 140px;"
          />
        </div>

        <div class="checkoutActions">
          <button class="checkoutBtn" (click)="enterAdmin()">Entsperren</button>
        </div>
      </div>
    </section>
  } @else {
    <!-- Nuevo producto -->
    <section class="checkout">
      <div class="checkoutBox">
        <div>
          <div class="muted">Neues Produkt</div>
          <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
            <input
              [(ngModel)]="newName"
              placeholder="Name (z.B. Cola)"
              style="padding: 12px; border-radius: 12px; min-width: 220px;"
            />

            <input
              [(ngModel)]="newPriceEUR"
              placeholder="Preis (z.B. 3,00)"
              inputmode="decimal"
              style="padding: 12px; border-radius: 12px; width: 160px;"
            />

            <select
              [(ngModel)]="newCategory"
              style="padding: 12px; border-radius: 12px; min-width: 170px;"
              title="Kategorie"
            >
              @for (c of categories; track c.value) {
                <option [ngValue]="c.value">{{ c.label }}</option>
              }
            </select>
          </div>

          <div class="muted" style="margin-top:8px;">
            Tipp: Preis akzeptiert z.B. <strong>3</strong>, <strong>3,5</strong>, <strong>€ 3,50</strong>, <strong>1.234,56</strong>
          </div>
        </div>

        <div class="checkoutActions">
          <button class="checkoutBtn" (click)="addProduct()" [disabled]="!canAddProduct">
            Hinzufügen
          </button>
          <button class="clearBtn" (click)="exitAdmin()">Sperren</button>
        </div>
      </div>
    </section>

    <!-- Productos -->
    <section class="sales">
      <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <h2>Produkte</h2>
          <div class="muted">Anzahl: {{ visibleProducts.length }}</div>
        </div>

        <!-- Búsqueda + filtros + orden -->
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input
            [(ngModel)]="search"
            placeholder="Suchen…"
            style="padding:10px; border-radius:12px; min-width:220px;"
          />

          <select
            [(ngModel)]="categoryFilter"
            style="padding:10px; border-radius:12px; min-width:170px;"
            title="Filter Kategorie"
          >
            <option value="all">Alle Kategorien</option>
            @for (c of categories; track c.value) {
              <option [value]="c.value">{{ c.label }}</option>
            }
          </select>

          <select
            [(ngModel)]="sortMode"
            style="padding:10px; border-radius:12px; min-width:170px;"
            title="Sortierung"
          >
            <option value="name-asc">Name (A–Z)</option>
            <option value="name-desc">Name (Z–A)</option>
            <option value="usage-desc">Meist genutzt</option>
            <option value="usage-asc">Wenig genutzt</option>
          </select>
        </div>
      </div>

      <ul class="salesList" style="margin-top:12px;">
        @for (p of visibleProducts; track p.id) {
          <li class="saleRow">
            <!-- Left column -->
            <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
              <input
                [(ngModel)]="p.name"
                (ngModelChange)="validateProduct(p)"
                (blur)="validateProduct(p)"
                placeholder="Name"
                style="padding:10px; border-radius:12px;"
              />

              @if (errorsById[''+p.id]?.name) {
                <div class="muted" style="color:#c62828;">
                  {{ errorsById[''+p.id]?.name }}
                </div>
              }

              <div class="muted">ID: {{ p.id }}</div>

              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <select
                  [(ngModel)]="p.category"
                  (change)="validateProduct(p)"
                  style="padding:10px; border-radius:12px; min-width:170px;"
                  title="Kategorie"
                >
                  <option [ngValue]="undefined">— Kategorie —</option>
                  @for (c of categories; track c.value) {
                    <option [ngValue]="c.value">{{ c.label }}</option>
                  }
                </select>

                @if (p.usageCount !== undefined) {
                  <div class="muted">Usage: {{ p.usageCount }}</div>
                }
              </div>

              @if (errorsById[''+p.id]?.category) {
                <div class="muted" style="color:#c62828;">
                  {{ errorsById[''+p.id]?.category }}
                </div>
              }
            </div>

            <!-- Right column -->
            <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
              <input
                [ngModel]="priceInputById[''+p.id] ?? ((p.priceCents ?? 0) / 100).toFixed(2).replace('.', ',')"
                (ngModelChange)="onPriceInput(p, $event)"
                (blur)="onPriceBlur(p); validateProduct(p)"
                inputmode="decimal"
                placeholder="0,00"
                style="padding:10px; border-radius:12px; width:140px; text-align:right;"
              />

              @if (errorsById[''+p.id]?.price) {
                <div class="muted" style="color:#c62828; text-align:right;">
                  {{ errorsById[''+p.id]?.price }}
                </div>
              }

              <strong>{{ formatEUR(p.priceCents ?? 0) }}</strong>

              <div style="display:flex; gap:10px; align-items:center;">
                <button
                  class="checkoutBtn"
                  (click)="updateProduct(p)"
                  [disabled]="hasErrors(p)"
                  [title]="hasErrors(p) ? 'Bitte Fehler beheben.' : 'Speichern'"
                >
                  Speichern
                </button>

                <button
                  class="clearBtn"
                  (click)="removeProduct(p)"
                  [disabled]="hasErrors(p)"
                  [title]="hasErrors(p) ? 'Bitte Fehler beheben, bevor du löschst.' : 'Löschen'"
                >
                  Löschen
                </button>
              </div>
            </div>
          </li>
        }
      </ul>
    </section>
  }
</div>
